#!/usr/bin/env sh

# 1 = git directory
# 2 = project name
# 3 = patch name
# 4?= remote
# 5?= branch

DIFFALL=0

while [ $# -gt 4 ] ; do
	case "$1" in
		-a)
			DIFFALL=1
			shift
			;;
		*)
			printf "Unknown option $1\n"
			;;
	esac
done

DIR=$PWD
PROJECT="$2"
PATCH="$3"

cd $1 || exit 1

if [ -n "$4" ] ; then
	if [ -n "$5" ] ; then
		BRANCH="$5"
	else
		BRANCH="master"
	fi

	REMOTE="$4"
else
	REMOTE="origin"
fi

REVISION=`git rev-parse --short $REMOTE/$BRANCH` || exit 1
OUTPUT="$DIR"/"$PROJECT-$PATCH-`date +%Y%m%d`-$REVISION.diff"
printf "%s\\n" "$OUTPUT"
if [ $DIFFALL -eq 1 ] ; then
	git diff "$REMOTE"/"$BRANCH" --output="$OUTPUT"
else
	git diff --diff-filter=M "$REMOTE"/"$BRANCH" --output="$OUTPUT"
fi
